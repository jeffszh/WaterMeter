<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>水表MBus测试</title>
	<script src="https://cdn.staticfile.org/jquery/1.8.3/jquery.min.js"></script>
	<script type="text/javascript">
        function setResult(txt)
        {
        	var pnl = document.getElementById("resultPanel");
        	pnl.innerHTML = txt;
        }

        function testAjx()
        {
        	$("#resultPanel").html("这样吧");
        }

		function ajaxPost(params, url) {
			$.ajax({
				type: "POST",
				url: url,
				data: params,
				dataType: "text",
				beforeSend: function(XMLHttpRequest) {
					setResult("正在调用node-red，请稍候……");
				},
				success: function(msg) {
					setResult(msg);
				},
				error: function(obj, msg, e) {
					setResult("调用出错：" + msg + " - " + e);
				}
			});
		}

		function writeMeterId() {
			var params = {};
			params.meterId = document.forms["form01"]["meterId"].value;
			ajaxPost(params, "http://localhost:1880/writeMeterId");
		}

		function openWebSock() {
			var ws = new WebSocket("ws://localhost:1880/ws/mbusResult");
			ws.onopen = function() {
				$("#wsStatus").html("在线");
				$("#msgPanel").html("-");
			}
			ws.onclose = function() {
				$("#wsStatus").html("离线");
				$("#msgPanel").html("X");
			}
			ws.onmessage = function(e) {
				$("#msgPanel").html(e.data);
			}
			ws.onerror = function() {
				$("#wsStatus").html("出错");
				$("#msgPanel").html("ERR");
			}
		}

		openWebSock();

	</script>
</head>
<body>
<form name="form01">
	水表编号：<input name="meterId" type="text">
	<input type="button" value="写入" onclick="writeMeterId();">
</form>
<hr>
<p id="resultPanel">空</p>
<hr>
<div id="wsStatus"></div>
<p id="msgPanel"></p>
</body>
</html>
